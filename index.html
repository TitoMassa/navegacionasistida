<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Move</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }

        #map {
            height: 400px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .status-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .time-display {
            font-size: 36px;
            font-weight: bold;
            color: #2c3e50;
        }

        .status-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .next-stop-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background-color: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background-color: #45a049;
        }

        .btn-secondary {
            background-color: #007BFF;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #0056b3;
        }

        .stops-list {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .stop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .stop-item:last-child {
            border-bottom: none;
        }

        .stop-actions {
            display: flex;
            gap: 10px;
        }

        .stop-actions button {
            padding: 8px 16px;
            font-size: 14px;
        }

        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.5);
            color: white;
            padding: 20px;
            border-radius: 8px;
            z-index: 1000;
        }

        .gps-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Smart Move</h1>
        
        <div id="map"></div>

        <div class="status-container">
            <div class="status-header">
                <h2>Estado actual</h2>
                <div class="gps-status">
                    <i class="fas fa-gps-dot"></i>
                    <span id="gps-status-text">Conectando GPS...</span>
                </div>
            </div>

            <div class="time-display-container">
                <div class="time-display">--:--</div>
            </div>

            <div class="status-details">
                <div class="next-stop-info">
                    <h3>Próxima parada:</h3>
                    <p id="next-stop-name">-</p>
                    <p id="next-stop-time">-</p>
                </div>
                <div class="controls">
                    <button class="btn btn-primary" onclick="previousStop()">Anterior</button>
                    <button class="btn btn-primary" onclick="nextStop()">Saltar</button>
                </div>
            </div>
        </div>

        <div class="stops-list">
            <h2>Lista de paradas</h2>
            <ul id="stops-list"></ul>
        </div>

        <div class="controls">
            <button class="btn btn-secondary" onclick="addStop()">Agregar parada</button>
            <button class="btn btn-secondary" onclick="clearRoute()">Limpiar ruta</button>
            <button class="btn btn-secondary" onclick="saveRoute()">Guardar ruta</button>
            <button class="btn btn-secondary" onclick="loadRoute()">Cargar ruta</button>
        </div>
    </div>

    <div class="loading" id="loading">Cargando...</div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        let map;
        let currentRoute = [];
        let currentStopIndex = 0;
        let watchId;

        // Mejorar la interfaz
        function initMap() {
            map = L.map('map').setView([0, 0], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            
            // Agregar marcador personalizado
            const DefaultIcon = L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41]
            });
            L.Marker.prototype.options.icon = DefaultIcon;
        }

        // Actualizar diferencia de tiempo
        function update_time_diff() {
            const now = new Date();
            const nextStop = currentRoute[currentStopIndex];
            if (!nextStop) return;

            const scheduledTime = new Date(nextStop.time);
            let diff = scheduledTime - now;
            
            if (diff < 0) diff = -diff;
            
            const minutes = Math.floor(diff / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);
            
            const sign = diff === scheduledTime - now ? '+' : '-';
            document.querySelector('.time-display').textContent = 
                `${sign}${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Verificar proxima parada
        function checkNextStop() {
            if (currentStopIndex >= currentRoute.length) return;
            
            const currentLocation = new L.LatLng(position.coords.latitude, position.coords.longitude);
            const nextStopLocation = new L.LatLng(currentRoute[currentStopIndex].coords.lat, currentRoute[currentStopIndex].coords.lng);
            
            const distance = currentLocation.distanceTo(nextStopLocation);
            if (distance < 20) {
                currentStopIndex++;
                update_time_diff();
                updateNextStopDisplay();
            }
        }

        // Actualizar display de proxima parada
        function updateNextStopDisplay() {
            if (currentStopIndex >= currentRoute.length) {
                document.getElementById('next-stop-name').textContent = '-';
                document.getElementById('next-stop-time').textContent = '-';
                return;
            }
            const nextStop = currentRoute[currentStopIndex];
            document.getElementById('next-stop-name').textContent = nextStop.name;
            document.getElementById('next-stop-time').textContent = new Date(nextStop.time).toLocaleTimeString();
        }

        // Funcionalidades de las paradas
        function previousStop() {
            if (currentStopIndex > 0) {
                currentStopIndex--;
                updateNextStopDisplay();
                update_time_diff();
            }
        }

        function nextStop() {
            if (currentStopIndex < currentRoute.length) {
                currentStopIndex++;
                updateNextStopDisplay();
                update_time_diff();
            }
        }

        // Manejo de paradas
        function addStop() {
            map.on('click', function(e) {
                const stopName = prompt('Ingrese el nombre de la parada:');
                const stopTime = prompt('Ingrese el horario programado (YYYY-MM-DDTHH:mm):');
                
                if (stopName && stopTime) {
                    currentRoute.push({
                        name: stopName,
                        time: stopTime,
                        coords: e.latlng
                    });
                    
                    updateStopsList();
                    L.marker(e.latlng).addTo(map);
                }
            });
        }

        function updateStopsList() {
            const stopsList = document.getElementById('stops-list');
            stopsList.innerHTML = '';
            
            currentRoute.forEach((stop, index) => {
                const li = document.createElement('li');
                li.className = 'stop-item';
                li.innerHTML = `
                    <div class="stop-info">
                        <strong>${stop.name}</strong>
                        <small>${new Date(stop.time).toLocaleString()}</small>
                    </div>
                    <div class="stop-actions">
                        <button onclick="removeStop(${index})"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                stopsList.appendChild(li);
            });
        }

        function removeStop(index) {
            currentRoute.splice(index, 1);
            updateStopsList();
        }

        function clearRoute() {
            currentRoute = [];
            updateStopsList();
            currentStopIndex = 0;
            update_time_diff();
            updateNextStopDisplay();
        }

        function saveRoute() {
            localStorage.setItem('currentRoute', JSON.stringify(currentRoute));
            alert('Ruta guardada correctamente');
        }

        function loadRoute() {
            const savedRoute = JSON.parse(localStorage.getItem('currentRoute'));
            if (savedRoute) {
                currentRoute = savedRoute;
                updateStopsList();
                currentStopIndex = 0;
                update_time_diff();
                updateNextStopDisplay();
            }
        }

        // Inicializar la aplicación
        function initApp() {
            initMap();
            
            if (navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(
                    function(position) {
                        document.getElementById('gps-status-text').textContent = 
                            `Ubicación actual: ${position.coords.latitude.toFixed(4)}, ${position.coords.longitude.toFixed(4)}`;
                        checkNextStop();
                        update_time_diff();
                    },
                    function(error) {
                        console.error('Error de geolocalización:', error);
                        document.getElementById('gps-status-text').textContent = 
                            'Error de geolocalización. Verifique su conexión GPS.';
                    },
                    {
                        enableHighAccuracy: true,
                        maximumAge: 1000,
                        distanceFilter: 20
                    }
                );
            } else {
                alert('La geolocalización no está soportada en este dispositivo');
            }

            // Cargar ruta guardada al inicio
            const savedRoute = JSON.parse(localStorage.getItem('currentRoute'));
            if (savedRoute) {
                currentRoute = savedRoute;
                updateStopsList();
                currentStopIndex = 0;
                update_time_diff();
                updateNextStopDisplay();
            }
        }

        // Iniciar la aplicación
        initApp();
    </script>
</body>
</html>
